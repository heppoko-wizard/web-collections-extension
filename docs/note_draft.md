# Edge CollectionsをChromeで使いたくて、拡張機能を自作した話

Microsoft Edgeの「コレクション」機能は優秀だ。
URL、画像、テキストメモをサイドパネルに放り込み、思考の断片を整理する。この体験に慣れすぎてしまい、もはやこれ無しではブラウジングができない。

ここには致命的な欠陥がある。Edgeでしか使えないことだ。

Chromeを使いたい時もある。BraveやVivaldiを試したい夜もある。そのたびに「コレクション」へのアクセスを絶たれる苦痛が、私をEdgeへと引き戻す。これは純粋な機能美であると同時に、巧妙なベンダーロックインでもある。

データはユーザーのものであるべきだ。ブラウザというただの閲覧ソフトごときに、思考プロセスまで人質に取られる道理はない。

そう考え、Chrome拡張機能「Web Collections」を開発した。Edge Collectionsと同等の機能を持ち、特定のベンダーに依存しないツールだ。

## サーバーレス、金はかけない

同期機能は必須だ。自宅のデスクトップで保存した記事を、出先のノートPCで参照できなければ意味がない。
そのために専用サーバーを立て、データベースを運用し、毎月のAWS利用料に怯えるのは御免だ。個人開発のツールにおいて、月額コストは最大の敵である。

同期バックエンドにはGitHub Gistを採用した。

エンジニアであれば、誰もがGitHubアカウントを持っている。Gistは本来コードスニペットを共有するための場所だが、実態は「APIで読み書きできる巨大なテキストストレージ」だ。しかも無料。Private Gistとして作成すれば、他人に見られることもない。

拡張機能からGist APIを叩き、JSONを投げつける。これだけで同期システムが完成する。サーバー管理の手間もコストもゼロ。実に美しい貧乏運用だ。

## 画像をJSONに詰め込む罪

コレクション機能には画像の保存が欠かせない。Gistはテキストしか保存できない。
外部の画像ホスティングサービスを使えば解決するが、それでは「サーバーレス・無料」の信条に反する。

画像をBase64エンコードし、JSONの中に直接埋め込むことにした。

Web標準の原則からすれば、この設計は悪夢に近い。数メガバイトの画像データが文字列としてJSONを肥大化させ、パース速度を低下させる。正気の沙汰ではない。

このツールは「私」が使うためのものだ。数万人が同時アクセスするWebサービスではない。
リサイズ（320px）とWebP圧縮を徹底し、1枚あたり数キロバイトまで落とし込めば、JSONが多少太ったところで現代のPCスペックなら誤差の範囲だ。

「正しさ」よりも「手軽さ」を選んだ。この割り切りこそが個人開発の醍醐味である。

## 禁断のデータ移行

拡張機能を作っただけでは終わらない。Edgeに溜め込んだ数年分のデータを救出する必要がある。
Edgeのエクスポート機能は貧弱だ。ExcelやWordに出力してどうしろというのか。

仕方がないので、Edgeの内部データベースを直接覗くことにした。
`AppData` の奥深くに眠る `collectionsSQLite` というファイル。これをPythonスクリプトで解析し、生のデータを引き抜く。

バイナリとして保存されていた画像データも、SQLクエリで強制的に抽出してBase64に変換する。
ブラウザの内部仕様に依存したスクリプトは、明日のアップデートで動かなくなるかもしれない。今この瞬間、データが抜け出せればそれでいい。

## クラウドストレージという「ローカル」

Gist同期は手軽だが、やはり容量制限が足枷になる。
次のバージョンでは、OneDriveやGoogle Driveの同期フォルダを直接参照する機能を実装する予定だ。

File System Access APIを使い、PC内の特定フォルダにJSONを書き出す。あとはOS常駐のドライブアプリが勝手にクラウドと同期してくれる。
API制限も、トークン管理も、ネットワークコードも不要。OSの機能にタダ乗りするこの方式こそ、最も堅牢でプライベートな同期システムかもしれない。

## 最後に

欲しい機能がなければ作ればいい。
そのための技術は、すでに手元にある。

ソースコードはGitHubで公開している。
私と同じように、Edgeの呪縛から逃れたいと願うなら、自由に使ってほしい。

<https://github.com/heppoko-wizard/web-collections-extension>
