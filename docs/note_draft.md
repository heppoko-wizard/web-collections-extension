# Edge CollectionsをChromeで使いたくて、拡張機能を自作した話

Microsoft Edgeのコレクション機能は優秀だ。
URL、画像、テキストメモをサイドパネルに放り込み、情報を整理する。この操作に慣れてしまい、他の方法では効率が落ちるほどだ。

ここには構造的な欠陥がある。Edgeでしか使えないことだ。

Chromeを使いたい時もある。BraveやVivaldiを試したいこともある。そのたびにコレクションへのアクセスを絶たれる不便さが、私をEdgeへと引き戻す。これは機能的な利点であると同時に、ベンダーロックインでもある。

データはユーザーのものであるべきだ。ブラウザの仕様に、私のメモやブックマークまで依存させる必要はない。

そう考え、Chrome拡張機能 Web Collections を開発した。Edge Collectionsと同等の機能を持ち、特定のベンダーに依存しないツールだ。

## サーバーレス、金はかけない

同期機能は必須だ。自宅のデスクトップで保存した記事を、出先のノートPCで参照できなければ意味がない。
そのために専用サーバーを立て、データベースを運用し、毎月のAWS利用料を支払うのは避けたい。個人開発のツールにおいて、固定費は最大のボトルネックだ。

同期バックエンドにはGitHub Gistを採用した。

エンジニアであれば、誰もがGitHubアカウントを持っている。Gistは本来コードスニペットを共有するための場所だが、実態はAPIで読み書きできるテキストストレージだ。しかも無料。Private Gistとして作成すれば、非公開で利用できる。

拡張機能からGist APIを叩き、JSONを送信する。これだけで同期システムが完成する。サーバー管理の手間もコストもゼロ。合理的な貧乏運用だ。

## 画像をJSONに埋め込む実装

コレクション機能には画像の保存が欠かせない。Gistはテキストしか保存できない。
外部の画像ホスティングサービスを使えば解決するが、それではサーバーレスかつ無料の方針に反する。

画像をBase64エンコードし、JSONの中に直接埋め込むことにした。

Web標準の原則からすれば、この設計は推奨されない。数メガバイトの画像データが文字列としてJSONを肥大化させ、パース速度を低下させる懸念がある。

このツールは私が使うためのものだ。数万人が同時アクセスするWebサービスではない。
リサイズ（320px）とWebP圧縮を徹底し、1枚あたり数キロバイトまで落とし込めば、JSONの肥大化も現代のPCスペックなら許容範囲に収まる。

正しさよりも手軽さを選んだ。この割り切りも個人開発においては重要だ。

## 内部DBからのデータ移行

拡張機能を作っただけでは終わらない。Edgeに蓄積した数年分のデータを救出する必要がある。
Edgeのエクスポート機能は、他のブラウザへの移行を想定していない。

Edgeの内部データベースを直接解析することにした。
AppData配下にある collectionsSQLite というファイル。これをPythonスクリプトで読み込み、生データを抽出する。

バイナリとして保存されていた画像データも、SQLクエリで抽出してBase64に変換する。
ブラウザの内部仕様に依存したスクリプトは、アップデートで動作しなくなるリスクがある。現時点でデータが移行できれば問題ない。

## ローカルファイル経由のクラウド同期

Gist同期は手軽だが、容量制限がある。
次のバージョンでは、OneDriveやGoogle Driveの同期フォルダを直接参照する機能を実装する予定だ。

File System Access APIを使い、PC内の特定フォルダにJSONを書き出す。あとはOS常駐のドライブアプリがクラウドと同期してくれる。
API制限も、トークン管理も不要。OSの機能を利用するこの方式こそ、最も堅牢な同期システムかもしれない。

## 最後に

欲しい機能がなければ作ればいい。
そのための技術は、すでに手元にある。

ソースコードはGitHubで公開している。
私と同じように、Edgeへの依存から抜け出したいと考えるなら、自由に使ってほしい。

<https://github.com/heppoko-wizard/web-collections-extension>
